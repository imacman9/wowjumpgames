<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Platformer Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Luckiest+Guy&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
        }
        canvas {
            display: block;
        }

        /* --- Main Menu Styles (UPDATED BACKGROUND IMAGE) --- */
        #mainMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%; /* Original width */
            max-width: 650px; /* Original max-width */
            padding: 50px 30px 30px 30px; /* Original padding */
            
            background-image: url('https://i.imgur.com/FhRSEjn.png'); /* <--- NEW MENU BACKGROUND IMAGE HERE */
            background-size: 100% 100%; /* Original background size */
            background-repeat: no-repeat;
            background-position: center;

            border-radius: 15px; /* Original border-radius */
            text-align: center;
            box-shadow: 0 0 25px rgba(0,0,0,0.8); /* Original box-shadow */
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Original content alignment */
            align-items: center;
            min-height: 400px; /* Original min-height */
            box-sizing: border-box;
            font-family: 'Luckiest Guy', 'Kalam', 'Comic Sans MS', cursive, sans-serif;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            color: #E0FFFF;
        }

        /* --- Start Button Style --- */
        #startButton {
            padding: 18px 40px;
            font-size: 2.2em;
            background-color: #6A5ACD;
            color: white;
            border: 3px solid #8B008B;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, border-color 0.3s;
            margin-top: auto;
            box-shadow: 0 7px 20px rgba(0,0,0,0.5);
            font-family: 'Luckiest Guy', 'Kalam', 'Comic Sans MS', cursive, sans-serif;
            z-index: 51;
        }
        #startButton:hover {
            background-color: #483D8B;
            transform: translateY(-3px);
            border-color: #FF1493;
        }
        #startButton:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
        }

        /* --- Mobile Controls Toggle Button --- */
        #mobileControlsMenuButton {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Kalam', cursive;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 51; 
        }
        #mobileControlsMenuButton:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.7);
        }

        #messageBox {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 40px;
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #444;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 100;
            font-family: 'Luckiest Guy', 'Kalam', 'Comic Sans MS', cursive, sans-serif;
        }
        #messageBox h2 {
            margin-top: 0;
            font-size: 2.2em;
            color: #4CAF50;
        }
        #messageBox button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: 'Luckiest Guy', 'Kalam', 'Comic Sans MS', cursive, sans-serif;
        }
        #messageBox button:hover {
            background-color: #45a049;
        }

        /* --- Fullscreen Button Styles --- */
        #fullscreenButton {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            color: white;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
            line-height: 1;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        #fullscreenButton:hover {
            background-color: rgba(0, 0, 0, 0.7);
            border-color: white;
        }

        /* --- Mobile Controls Styles (D-PAD) --- */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none; /* Hidden by default */
            justify-content: space-between;
            align-items: flex-end;
            z-index: 20;
            pointer-events: none; /* Initially non-interactive */
        }

        #dpad-container {
            display: grid;
            grid-template-columns: repeat(3, 60px); /* 3 columns for 60px buttons */
            grid-template-rows: repeat(3, 60px);    /* 3 rows for 60px buttons */
            gap: 2px; /* Small gap between buttons */
            background: rgba(255, 255, 255, 0.15); /* Slight background for the D-pad area */
            border-radius: 10px;
            padding: 5px;
            pointer-events: auto; /* Make the container interactive */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .dpad-button {
            width: 60px;
            height: 60px;
            background: rgba(100, 100, 100, 0.7); /* Greyish background */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em; /* Larger arrow symbols */
            border-radius: 8px; /* Slightly rounded corners */
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            transition: background-color 0.1s ease, transform 0.1s ease;
        }

        .dpad-button:active {
            background: rgba(150, 150, 150, 0.9); /* Lighter on press */
            transform: translateY(1px); /* Slight press effect */
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }

        /* Grid placement for D-pad buttons */
        #dpad-up { grid-area: 1 / 2 / 2 / 3; } /* Row 1, Col 2 */
        #dpad-left { grid-area: 2 / 1 / 3 / 2; } /* Row 2, Col 1 */
        #dpad-center { grid-area: 2 / 2 / 3 / 3; background: none; box-shadow: none;} /* Invisible center */
        #dpad-right { grid-area: 2 / 3 / 3 / 4; } /* Row 2, Col 3 */
        #dpad-down { grid-area: 3 / 2 / 4 / 3; } /* Row 3, Col 2 */


        /* Jump button remains the same */
        #jump-button {
            width: 100px;
            height: 100px;
            background: #4CAF50; /* Green for jump */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            pointer-events: auto;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: background-color 0.1s ease, transform 0.1s ease;
            font-family: 'Luckiest Guy', 'Kalam', cursive;
        }
        #jump-button:active {
            transform: translateY(2px);
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="mainMenu">
        <button id="mobileControlsMenuButton">Show Mobile Controls</button>
        <button id="startButton">Start Game</button>
    </div>

    <div id="messageBox">
        <h2 id="messageText"></h2>
        <button id="restartButton">Play Again</button>
    </div>
    <div id="fullscreenButton" title="Toggle Fullscreen">
        &#x26F6;
    </div>
    <div id="mobile-controls">
        <div id="dpad-container">
            <div id="dpad-up" class="dpad-button">&#9650;</div> <div id="dpad-left" class="dpad-button">&#9664;</div> <div id="dpad-center" class="dpad-button"></div> <div id="dpad-right" class="dpad-button">&#9654;</div> <div id="dpad-down" class="dpad-button">&#9660;</div> </div>
        <div id="jump-button">JUMP</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    

    <script>
        // === Global Game State Flag ===
        let gameRunning = false;

        // === Basic Setup ===
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky blue background
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // === Physics World ===
        // IMPORTANT: If 'CANNON' is undefined here, it means cannon.js failed to load.
        if (typeof CANNON === 'undefined') {
            console.error("ERROR: CANNON.js library is not loaded! Physics will not work. Please ensure it's loaded from a working CDN.");
            alert("CANNON.js physics library failed to load. The game's physics will not function. This could be due to network restrictions.");
            // Stop game execution or degrade gracefully if physics is essential
            gameRunning = false; 
        } else {
            console.log("CANNON.js library detected. Initializing physics world.");
        }

        const world = new CANNON.World();
        world.gravity.set(0, -20, 0); // Stronger gravity for a platformer feel
        world.broadphase = new CANNON.NaiveBroadphase();
        world.solver.iterations = 20; // Increased solver iterations for better stability
        world.solver.tolerance = 0.001; // Added tolerance for more precision
        world.defaultContactMaterial.friction = 0.5; // General friction between bodies
        world.defaultContactMaterial.restitution = 0.1; // General bounciness
        console.log("CANNON.js physics world initialized.");

        // === Lighting ===
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 500;
        scene.add(directionalLight);

        // === Player ===
        const playerSize = 1.5;
        const textureLoader = new THREE.TextureLoader();
        const playerTexture = textureLoader.load(
            'https://i.imgur.com/cV6r1ty.png', // This is still the old player image, NOT the new menu image
            undefined,
            undefined,
            (err) => {
                console.error('An error happened loading the player texture.', err);
                playerMesh.material = new THREE.MeshLambertMaterial({ color: 0xff4500 }); // Fallback color
                playerMesh.material.needsUpdate = true;
            }
        );

        const playerGeo = new THREE.PlaneGeometry(playerSize, playerSize);
        const playerMat = new THREE.MeshLambertMaterial({
            map: playerTexture,
            color: 0xffffff,
            transparent: true,
            side: THREE.DoubleSide
        });
        const playerMesh = new THREE.Mesh(playerGeo, playerMat);
        playerMesh.castShadow = true;
        scene.add(playerMesh);

        // --- Physics Material for Player ---
        const playerPhysicsMaterial = new CANNON.Material("playerMaterial");
        const playerShape = new CANNON.Box(new CANNON.Vec3(playerSize / 2, playerSize / 2, 0.5)); 
        const playerBody = new CANNON.Body({ mass: 5, shape: playerShape, material: playerPhysicsMaterial });
        playerBody.allowSleep = false; 
        playerBody.fixedRotation = true;
        playerBody.linearDamping = 0.1;
        playerBody.angularDamping = 0.9;

        let startPosition = new CANNON.Vec3(0, 5, 0); 
        playerBody.position.copy(startPosition);
        world.addBody(playerBody);
        console.log("Player physics body created and added to world. fixedRotation set to true.");

        // === Platforms ===
        let platforms = [];
        const winPlatformMaterial = new CANNON.Material("winPlatformMaterial");
        const regularPlatformMaterial = new CANNON.Material("regularPlatformMaterial");
        let endPlatformBody = null;

        // --- Define contact materials for physics interactions ---
        const playerRegularContactMaterial = new CANNON.ContactMaterial(
            playerPhysicsMaterial,
            regularPlatformMaterial,
            {
                friction: 0.5,
                restitution: 0.05
            }
        );
        world.addContactMaterial(playerRegularContactMaterial);

        const playerWinContactMaterial = new CANNON.ContactMaterial(
            playerPhysicsMaterial,
            winPlatformMaterial,
            {
                friction: 1.0,
                restitution: 0.0,
                contactEquationStiffness: 1e8,
                contactEquationRelaxation: 3
            }
        );
        world.addContactMaterial(playerWinContactMaterial);

        function createPlatform(size, position, color = 0xaaaaaa, isWinPlatform = false) {
            const platformGeo = new THREE.BoxGeometry(size.x, size.y, size.z);
            const platformMat = new THREE.MeshLambertMaterial({ color: color });
            const platformMesh = new THREE.Mesh(platformGeo, platformMat);
            platformMesh.position.copy(position);
            platformMesh.receiveShadow = true;
            scene.add(platformMesh);

            const platformShape = new CANNON.Box(new CANNON.Vec3(size.x / 2, size.y / 2, size.z / 2));
            const platformBody = new CANNON.Body({
                mass: 0, // Static body
                shape: platformShape,
                position: position,
                material: isWinPlatform ? winPlatformMaterial : regularPlatformMaterial
            });
            world.addBody(platformBody);
            return { mesh: platformMesh, body: platformBody };
        }

        // --- Random Level Generation ---
        function clearCurrentLevel() {
            platforms.forEach(p => {
                scene.remove(p.mesh);
                world.removeBody(p.body);
                p.mesh.geometry.dispose();
                p.mesh.material.dispose();
            });
            platforms = [];
            endPlatformBody = null;
        }

        function generateRandomLevel() {
            clearCurrentLevel();

            const startPlatSize = { x: 10, y: 1, z: 10 };
            const startPlatPos = { x: 0, y: 0, z: 0 };
            platforms.push(createPlatform(startPlatSize, new THREE.Vector3(startPlatPos.x, startPlatPos.y, startPlatPos.z)));
            
            startPosition.set(startPlatPos.x, startPlatPos.y + 5, startPlatPos.z); 

            let lastPlatformPos = new THREE.Vector3(startPlatPos.x, startPlatPos.y, startPlatPos.z);

            const numPlatforms = Math.floor(Math.random() * 8) + 7;

            for (let i = 0; i < numPlatforms; i++) {
                let newPlatformX, newPlatformY, newPlatformZ;
                let newPlatformSizeX = Math.random() * 5 + 3;
                let newPlatformSizeZ = Math.random() * 5 + 3;
                let newPlatformSizeY = 1;

                newPlatformX = lastPlatformPos.x + (Math.random() * 20 - 10);
                newPlatformZ = lastPlatformPos.z + (Math.random() * 20 - 10);
                newPlatformY = lastPlatformPos.y + (Math.random() * 6 - 2);
                newPlatformY = Math.max(newPlatformY, -10);

                const isWinPlat = (i === numPlatforms - 1);

                const newPlatform = createPlatform(
                    { x: newPlatformSizeX, y: newPlatformSizeY, z: newPlatformSizeZ },
                    new THREE.Vector3(newPlatformX, newPlatformY, newPlatformZ),
                    isWinPlat ? 0x00ff00 : 0xaaaaaa,
                    isWinPlat
                );
                platforms.push(newPlatform);
                lastPlatformPos = newPlatform.mesh.position;

                if (isWinPlat) {
                    endPlatformBody = newPlatform.body;
                }
            }
        }

        generateRandomLevel();

        // --- Music Setup ---
        const listener = new THREE.AudioListener();
        camera.add(listener);

        const backgroundMusic = new THREE.Audio(listener);
        const audioLoader = new THREE.AudioLoader();
        const musicUrl = 'https://ia600900.us.archive.org/26/items/music1_20250625/music1.mp3';
        let musicStarted = false;

        function playBackgroundMusic() {
            if (!musicStarted) {
                audioLoader.load(musicUrl, function(buffer) {
                    backgroundMusic.setBuffer(buffer);
                    backgroundMusic.setLoop(true);
                    backgroundMusic.setVolume(0.5);
                    backgroundMusic.play();
                }, undefined, function(err) {
                    console.error('An error occurred loading the background music:', err);
                });
                musicStarted = true;
            }
        }

        // --- Jump Sound Setup ---
        const jumpSound = new THREE.Audio(listener);
        const jumpSoundUrl = 'https://ia801508.us.archive.org/17/items/jump_20250625/jump.mp3';
        let jumpSoundBuffer = null;

        audioLoader.load(jumpSoundUrl, function(buffer) {
            jumpSoundBuffer = buffer;
            jumpSound.setBuffer(jumpSoundBuffer);
            jumpSound.setVolume(0.7);
        }, undefined, function(err) {
            console.error('An error occurred loading the jump sound:', err);
        });


        // --- Keyboard Controls ---
        const keys = {};
        document.addEventListener('keydown', (event) => {
            keys[event.code] = true;
        });
        document.addEventListener('keyup', (event) => {
            keys[event.code] = false;
        });

        let canJump = false;
        const contactNormal = new CANNON.Vec3();
        const up = new CANNON.Vec3(0, 1, 0);

        playerBody.addEventListener("collide", (e) => {
            const contact = e.contact;
            if (contact.bi.id === playerBody.id) { 
                contact.ni.negate(contactNormal); 
            } else { 
                contactNormal.copy(contact.ni); 
            }

            if (contactNormal.dot(up) > 0.5) { 
                if (!canJump) { 
                    canJump = true;
                }
            } else {
                if (canJump) { 
                    canJump = false;
                }
            }
            
            if (endPlatformBody && (e.body === endPlatformBody)) {
                if (playerBody.velocity.y < 0.1 && contactNormal.dot(up) > 0.8) {
                    console.log("Player reached win platform! Generating new level.");
                    generateRandomLevel();
                    resetPlayer();
                }
            }
        });

        function handleKeyboardControls() {
            const speed = 10; 
            const jumpForce = 15;

            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            cameraDirection.y = 0;
            cameraDirection.normalize();

            const right = new THREE.Vector3().crossVectors(camera.up, cameraDirection).normalize();

            let moveDirection = new THREE.Vector3();

            if (keys['KeyW'] || keys['ArrowUp']) {
                 moveDirection.add(cameraDirection);
            }
            if (keys['KeyS'] || keys['ArrowDown']) {
                 moveDirection.sub(cameraDirection);
            }
            if (keys['KeyA'] || keys['ArrowLeft']) {
                 moveDirection.add(right);
            }
            if (keys['KeyD'] || keys['ArrowRight']) {
                 moveDirection.sub(right);
            }

            let currentYVelocity = playerBody.velocity.y;

            if (moveDirection.lengthSq() > 0) {
                moveDirection.normalize().multiplyScalar(speed);
                playerBody.velocity.x = moveDirection.x;
                playerBody.velocity.z = moveDirection.z;
            } else {
                if (playerBody.velocity.x !== 0 || playerBody.velocity.z !== 0) {
                    playerBody.velocity.x = 0;
                    playerBody.velocity.z = 0;
                }
            }
            
            playerBody.velocity.y = currentYVelocity;

            if ((keys['Space']) && canJump) {
                playerBody.velocity.y = jumpForce;
                canJump = false;

                if (jumpSoundBuffer) {
                    if (jumpSound.isPlaying) {
                        jumpSound.stop();
                    }
                    jumpSound.play();
                }
            }
        }

        // --- Mobile Controls Logic (D-PAD) ---
        const mobileControlsDiv = document.getElementById('mobile-controls');
        const jumpButton = document.getElementById('jump-button');
        const mobileControlsMenuButton = document.getElementById('mobileControlsMenuButton');

        const dpadUp = document.getElementById('dpad-up');
        const dpadDown = document.getElementById('dpad-down');
        const dpadLeft = document.getElementById('dpad-left');
        const dpadRight = document.getElementById('dpad-right');

        let dPadUpPressed = false;
        let dPadDownPressed = false;
        let dPadLeftPressed = false;
        let dPadRightPressed = false;

        function setDpadButtonState(button, isPressed) {
            switch (button.id) {
                case 'dpad-up': dPadUpPressed = isPressed; break;
                case 'dpad-down': dPadDownPressed = isPressed; break;
                case 'dpad-left': dPadLeftPressed = isPressed; break;
                case 'dpad-right': dPadRightPressed = isPressed; break;
            }
        }

        [dpadUp, dpadDown, dpadLeft, dpadRight].forEach(button => {
            button.addEventListener('touchstart', (e) => {
                if (!gameRunning || mobileControlsDiv.style.display === 'none') return;
                e.preventDefault();
                setDpadButtonState(button, true);
            }, { passive: false });

            button.addEventListener('touchend', (e) => {
                if (!gameRunning || mobileControlsDiv.style.display === 'none') return;
                setDpadButtonState(button, false);
            });

            button.addEventListener('touchcancel', (e) => {
                if (!gameRunning || mobileControlsDiv.style.display === 'none') return;
                setDpadButtonState(button, false);
            });
        });

        jumpButton.addEventListener('touchstart', (e) => {
            if (!gameRunning || mobileControlsDiv.style.display === 'none') return;
            e.preventDefault();
            if (canJump) {
                playerBody.velocity.y = 15; 
                canJump = false;
                if (jumpSoundBuffer) {
                    if (jumpSound.isPlaying) {
                        jumpSound.stop();
                    }
                    jumpSound.play();
                }
            }
        }, { passive: false });

        function handleMobileControls() {
            const speed = 10;
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            cameraDirection.y = 0;
            cameraDirection.normalize();

            const right = new THREE.Vector3().crossVectors(camera.up, cameraDirection).normalize();

            let moveDirection = new THREE.Vector3();

            if (dPadUpPressed) {
                moveDirection.add(cameraDirection);
            }
            if (dPadDownPressed) {
                moveDirection.sub(cameraDirection);
            }
            if (dPadLeftPressed) {
                moveDirection.add(right);
            }
            if (dPadRightPressed) {
                moveDirection.sub(right);
            }

            let currentYVelocity = playerBody.velocity.y;

            if (moveDirection.lengthSq() > 0) { 
                moveDirection.normalize().multiplyScalar(speed); 
                playerBody.velocity.x = moveDirection.x;
                playerBody.velocity.z = moveDirection.z;
            } else {
                if (playerBody.velocity.x !== 0 || playerBody.velocity.z !== 0) {
                    playerBody.velocity.x = 0;
                    playerBody.velocity.z = 0;
                }
            }
            playerBody.velocity.y = currentYVelocity;
        }

        let mobileControlsVisible = false;

        mobileControlsMenuButton.addEventListener('click', () => {
            mobileControlsVisible = !mobileControlsVisible;
            if (mobileControlsVisible) {
                mobileControlsDiv.style.display = 'flex';
                mobileControlsDiv.style.pointerEvents = 'auto';
                mobileControlsMenuButton.textContent = 'Hide Mobile Controls';
            } else {
                mobileControlsDiv.style.display = 'none';
                mobileControlsDiv.style.pointerEvents = 'none';
                dPadUpPressed = dPadDownPressed = dPadLeftPressed = dPadRightPressed = false;
                playerBody.velocity.x = 0; 
                playerBody.velocity.z = 0;
                mobileControlsMenuButton.textContent = 'Show Mobile Controls';
            }
        });


        // === UI Element References ===
        const mainMenu = document.getElementById('mainMenu');
        const startButton = document.getElementById('startButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const restartButton = document.getElementById('restartButton');
        const fullscreenButton = document.getElementById('fullscreenButton');


        // === Game Start / End Functions ===
        function startGame() {
            mainMenu.style.opacity = 0;
            mainMenu.style.visibility = 'hidden';
            gameRunning = true;
            playBackgroundMusic();
            if (!animationFrameId) {
                animate();
            }
        }

        function resetPlayer() {
            playerBody.position.copy(startPosition);
            playerBody.velocity.set(0, 0, 0);
            playerBody.angularVelocity.set(0, 0, 0);
            canJump = false;
        }

        // === Event Listeners for UI ===
        startButton.addEventListener('click', startGame);

        restartButton.addEventListener('click', () => {
             messageBox.style.display = 'none';
             generateRandomLevel();
             resetPlayer();
        });

        fullscreenButton.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        document.addEventListener('fullscreenchange', () => {
        });

        // --- Game Loop ---
        let animationFrameId = null; 
        const fixedTimeStep = 1 / 60;
        let lastTime;

        function animate(time) {
            if (!gameRunning) {
                animationFrameId = null;
                return;
            }

            animationFrameId = requestAnimationFrame(animate);

            if (lastTime === undefined) lastTime = time;
            const dt = (time - lastTime) / 1000;
            lastTime = time;

            if (mobileControlsDiv.style.display === 'none') {
                handleKeyboardControls(); 
            } else {
                handleMobileControls(); 
            }

            world.step(fixedTimeStep, dt, 10);
            
            playerMesh.position.copy(playerBody.position);

            const playerLookAtPos = new THREE.Vector3(camera.position.x, playerMesh.position.y, camera.position.z);
            playerMesh.lookAt(playerLookAtPos);

            const cameraOffset = new THREE.Vector3(10, 8, 10);
            const playerPosition = playerMesh.position;
            
            const newCameraPosition = playerPosition.clone().add(cameraOffset);
            
            camera.position.lerp(newCameraPosition, 0.1);
            
            camera.lookAt(playerPosition);

            if (playerMesh.position.y < -30) {
                resetPlayer();
            }

            renderer.render(scene, camera);
        }

        gameRunning = false; 

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }, false);
    </script>
</body>
</html>